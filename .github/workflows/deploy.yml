name: Deploy to VPS

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy-infomaniak:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy to Infomaniak (ancien)
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: 83.228.207.79
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 49125
        script: |
          echo "ðŸš€ DÃ©ploiement de litalien.fr sur Infomaniak..."

          PROJECT_DIR="/var/www/apps/litalien.fr"
          APP_NAME="$(echo litalien.fr | sed 's/\./-/g')"

          cd "$PROJECT_DIR"

          git stash push -m "auto-deploy-$(date +%Y%m%d-%H%M%S)" --include-untracked
          git fetch origin
          git reset --hard origin/main || git reset --hard origin/master

          if [ -f "pnpm-lock.yaml" ]; then
            pnpm install --frozen-lockfile
          elif [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi

          if [ -f "package.json" ] && grep -q '"build"' package.json; then
            echo "ðŸ”¨ Build en cours..."
            pnpm build || npm run build
          fi

          pm2 restart "$APP_NAME" || echo "App PM2 non trouvÃ©e"

          echo "âœ… DÃ©ploiement Infomaniak terminÃ©!"

  deploy-ovh:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy to OVH (nouveau)
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: 54.37.228.99
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          echo "ðŸš€ DÃ©ploiement de litalien.fr sur OVH..."

          PROJECT_DIR="/var/www/apps/litalien.fr"
          APP_NAME="$(echo litalien.fr | sed 's/\./-/g')"

          cd "$PROJECT_DIR"

          git stash push -m "auto-deploy-$(date +%Y%m%d-%H%M%S)" --include-untracked
          git fetch origin
          git reset --hard origin/main || git reset --hard origin/master

          if [ -f "pnpm-lock.yaml" ]; then
            pnpm install --frozen-lockfile
          elif [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi

          if [ -f "package.json" ] && grep -q '"build"' package.json; then
            echo "ðŸ”¨ Build en cours..."
            pnpm build || npm run build
          fi

          pm2 restart "$APP_NAME" || echo "App PM2 non trouvÃ©e"

          echo "âœ… DÃ©ploiement OVH terminÃ©!"
