name: Deploy to VPS

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to VPS
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: 83.228.207.79
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          echo "ðŸš€ DÃ©ploiement de litalien.fr..."
          
          # Variables
          PROJECT_DIR="/var/www/apps/litalien.fr"
          APP_NAME="$(echo litalien.fr | sed 's/\./-/g')"
          
          # Aller dans le projet
          cd "$PROJECT_DIR"
          
          # TOUJOURS sauvegarder et forcer la mise Ã  jour
          git stash push -m "auto-deploy-$(date +%Y%m%d-%H%M%S)" --include-untracked
          git fetch origin
          git reset --hard origin/main || git reset --hard origin/master
          
          # Installer les dÃ©pendances
          if [ -f "pnpm-lock.yaml" ]; then
            pnpm install --frozen-lockfile
          elif [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi
          
          # Build si nÃ©cessaire
          if [ -f "package.json" ] && grep -q '"build"' package.json; then
            echo "ðŸ”¨ Build en cours..."
            pnpm build || npm run build
          fi
          
          # RedÃ©marrer PM2
          pm2 restart "$APP_NAME" || echo "App PM2 non trouvÃ©e"
          
          echo "âœ… DÃ©ploiement terminÃ©!"
